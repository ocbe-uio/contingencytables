#' @title Stratified 2x2 tables
#' @param n the observed table (a 2x2xk matrix, where k is the number of strata)
#' @param alpha the nominal level, e.g. 0.05 for 95% CIs
#' @examples
#' # Smoking and lung cancer (Doll and Hill, 1950)
#' stratified_2x2_tables(doll_hill_1950)
#'
#' # Prophylactice use of Lidocaine in myocardial infarction (Hine et al., 1989)
#' stratified_2x2_tables(hine_1989)
#'
#' @export
#' @return A string of "-". This function should be called for its printed output
stratified_2x2_tables <- function(n, alpha = 0.05) {
  validateArguments(mget(ls()))

  cat("\n")
  my_sprintf("\nThe stratum-specific effect estimates\n")
  my_sprintf("-------------------------------------\n")

  K <- dim(n)[3]
  n1pk <- apply(n[1, , ], 2, sum)
  n2pk <- apply(n[2, , ], 2, sum)
  z_alpha <- qnorm(1 - alpha / 2, 0, 1)

  my_sprintf("The difference between probabilities\n")
  for (k in 1:K) {
    estimate <- n[1, 1, k] / n1pk[k] - n[2, 1, k] / n2pk[k]
    SE <- sqrt(n[1, 1, k] * n[1, 2, k] / (n1pk[k]^3) + n[2, 1, k] * n[2, 2, k] / (n2pk[k]^3))
    L <- estimate - z_alpha * SE
    U <- estimate + z_alpha * SE
    my_sprintf("  Stratum #%i: deltahat_%i = %6.4f (%g%% Wald CI %6.4f to %6.4f)\n", k, k, estimate, 100 * (1 - alpha), L, U)
  }

  cat("\n")
  my_sprintf("\nThe ratio of probabilities\n")
  for (k in 1:K) {
    estimate <- (n[1, 1, k] / n1pk[k]) / (n[2, 1, k] / n2pk[k])
    SE <- sqrt(1 / n[1, 1, k] - 1 / n1pk[k] + 1 / n[2, 1, k] - 1 / n2pk[k])
    L <- exp(log(estimate) - z_alpha * SE)
    U <- exp(log(estimate) + z_alpha * SE)
    my_sprintf("  Stratum #%i: phihat_%i = %6.4f (%g%% Wald CI %6.4f to %6.4f)\n", k, k, estimate, 100 * (1 - alpha), L, U)
  }

  cat("\n")
  my_sprintf("\nThe odds ratio\n")
  for (k in 1:K) {
    estimate <- (n[1, 1, k] / n[1, 2, k]) / (n[2, 1, k] / n[2, 2, k])
    SE <- sqrt(1 / n[1, 1, k] + 1 / n[1, 2, k] + 1 / n[2, 1, k] + 1 / n[2, 2, k])
    L <- exp(log(estimate) - z_alpha * SE)
    U <- exp(log(estimate) + z_alpha * SE)
    my_sprintf("  Stratum #%i: thetahat_%i = %6.4f (%g%% Wald CI %6.4f to %6.4f)\n", k, k, estimate, 100 * (1 - alpha), L, U)
  }

  cat("\n")
  my_sprintf("\nEstimating a common difference between probabilities\n")
  my_sprintf("----------------------------------------------------\n")
  estimate <- MantelHaenszel_estimate_stratified_2x2(n, "linear")$statistics[[1]]
  my_sprintf("The Mantel-Haenszel estimate = %7.4f\n", estimate)
  estimate <- InverseVariance_estimate_stratified_2x2(n, "linear")$statistics[[1]]
  my_sprintf("The inverse variance estimate = %7.4f\n", estimate)

  cat("\n")
  my_sprintf("\nEstimating a common ratio of probabilities\n")
  my_sprintf("------------------------------------------\n")
  estimate <- MantelHaenszel_estimate_stratified_2x2(n, "log")$statistics[[1]]
  my_sprintf("The Mantel-Haenszel estimate = %7.4f\n", estimate)
  estimate <- InverseVariance_estimate_stratified_2x2(n, "log")$statistics[[1]]
  my_sprintf("The inverse variance estimate = %7.4f\n", estimate)

  cat("\n")
  my_sprintf("\nEstimating a common odds ratio\n")
  my_sprintf("------------------------------\n")
  estimate <- MantelHaenszel_estimate_stratified_2x2(n, "logit")$statistics[[1]]
  my_sprintf("The Mantel-Haenszel estimate = %7.4f\n", estimate)
  estimate <- InverseVariance_estimate_stratified_2x2(n, "logit")$statistics[[1]]
  my_sprintf("The inverse variance estimate = %7.4f\n", estimate)
  estimate <- Peto_OR_estimate_stratified_2x2(n)$statistics[[1]]
  my_sprintf("The Peto OR estimate = %7.4f\n", estimate)

  my_sprintf("\nTests of homogeneity of the difference between probabilities\n")
  my_sprintf("============================================================\n")
  my_sprintf("Test                 P-value  (test statistic)\n")
  my_sprintf("-------------------------------------------------\n")
  tmp <- Cochran_Q_test_stratified_2x2(n, "linear", "MH")
  P <- tmp$pvalue
  Q <- tmp$estimate
  df <- tmp$df
  my_sprintf("Cochran Q (MH)       %6.4f   (Q = %5.3f, df = %i)\n", P, Q, df)
  tmp <- Cochran_Q_test_stratified_2x2(n, "linear", "IV")
  P <- tmp$pvalue
  Q <- tmp$estimate
  df <- tmp$df
  my_sprintf("Cochran Q (IV)       %6.4f   (Q = %5.3f, df = %i)\n", P, Q, df)
  results <- Pearson_LR_homogeneity_test_stratified_2x2(n, "linear")$statistics
  my_sprintf("Likelihood ratio     %6.4f   (T = %5.3f, df = %i)\n", results$P_LR, results$T_LR, results$df_LR)
  my_sprintf("Pearson chi-squared  %6.4f   (T = %5.3f, df = %i)\n", results$P_Pearson, results$T_Pearson, results$df_Pearson)
  my_sprintf("-------------------------------------------------\n")

  cat("\n")
  my_sprintf("\nTests of homogeneity of the ratio of probabilities\n")
  my_sprintf("================================================\n")
  my_sprintf("Test                 P-value  (test statistic)\n")
  my_sprintf("-------------------------------------------------\n")
  tmp <- Cochran_Q_test_stratified_2x2(n, "log", "MH")
  P <- tmp$pvalue
  Q <- tmp$estimate
  df <- tmp$df
  my_sprintf("Cochran Q (MH)       %6.4f   (Q = %5.3f, df = %i)\n", P, Q, df)
  tmp <- Cochran_Q_test_stratified_2x2(n, "log", "IV")
  P <- tmp$pvalue
  Q <- tmp$estimate
  df <- tmp$df
  my_sprintf("Cochran Q (IV)       %6.4f   (Q = %5.3f, df = %i)\n", P, Q, df)
  results <- Pearson_LR_homogeneity_test_stratified_2x2(n, "log")$statistics
  my_sprintf("Likelihood ratio     %6.4f   (T = %5.3f, df = %i)\n", results$P_LR, results$T_LR, results$df_LR)
  my_sprintf("Pearson chi-squared  %6.4f   (T = %5.3f, df = %i)\n", results$P_Pearson, results$T_Pearson, results$df_Pearson)
  my_sprintf("-------------------------------------------------\n")

  cat("\n")
  my_sprintf("\nTests of homogeneity of odds ratios\n")
  my_sprintf("===================================\n")
  my_sprintf("Test                             P-value  (test statistic)\n")
  my_sprintf("-------------------------------------------------------------\n")
  tmp <- Cochran_Q_test_stratified_2x2(n, "logit", "MH")
  P <- tmp$pvalue
  Q <- tmp$estimate
  df <- tmp$df
  my_sprintf("Cochran Q (MH)                   %6.4f   (Q = %5.3f, df = %i)\n", P, Q, df)
  tmp <- Cochran_Q_test_stratified_2x2(n, "logit", "IV")
  P <- tmp$pvalue
  Q <- tmp$estimate
  df <- tmp$df
  my_sprintf("Cochran Q (IV)                   %6.4f   (Q = %5.3f, df = %i)\n", P, Q, df)
  results <- Pearson_LR_homogeneity_test_stratified_2x2(n, "logit")$statistics
  my_sprintf("Likelihood ratio                 %6.4f   (T = %5.3f, df = %i)\n", results$P_LR, results$T_LR, results$df_LR)
  my_sprintf("Pearson chi-squared              %6.4f   (T = %5.3f, df = %i)\n", results$P_Pearson, results$T_Pearson, results$df_Pearson)
  tmp <- BreslowDay_homogeneity_test_stratified_2x2(n)
  P <- tmp$pvalue
  T0 <- tmp$estimate
  df <- tmp$df
  my_sprintf("Breslow-Day W/Tarone correction  %6.4f   (T = %5.3f, df = %i)\n", P, T0, df)
  tmp <- Peto_homogeneity_test_stratified_2x2(n)$statistics
  P <- tmp[[1]]
  T0 <- tmp[[2]]
  df <- tmp[[3]]
  my_sprintf("Peto                             %6.4f   (T = %5.3f, df = %i)\n", P, T0, df)
  my_sprintf("-------------------------------------------------------------\n")


  my_sprintf("\nTests and CIs for a common difference between probabilities\n")
  my_sprintf("===========================================================\n")
  results <- Pearson_LR_test_common_effect_stratified_2x2(n, "linear")$statistics
  my_sprintf("Test                 P-value  (test statistic)\n")
  my_sprintf("-------------------------------------------------\n")
  my_sprintf("Likelihood ratio     %6.4f   (T = %5.3f, df = %i)\n", results$P_LR, results$T_LR, results$df_LR)
  my_sprintf("Pearson chi-squared  %6.4f   (T = %5.3f, df = %i)\n", results$P_Pearson, results$T_Pearson, results$df_Pearson)
  tmp <- Wald_test_and_CI_common_diff_stratified_2x2(n, "MH", alpha, FALSE)
  P <- tmp[[1]]
  Z <- tmp[[2]]
  L_MH <- tmp[[3]]
  U_MH <- tmp[[4]]
  deltahat_MH <- tmp[[5]]
  my_sprintf("Wald (MH)            %6.4f   (Z = %5.3f)\n", P, Z)
  tmp <- Wald_test_and_CI_common_diff_stratified_2x2(n, "IV", alpha, FALSE)
  P <- tmp[[1]]
  Z <- tmp[[2]]
  L_IV <- tmp[[3]]
  U_IV <- tmp[[4]]
  deltahat_IV <- tmp[[5]]
  my_sprintf("Wald (IV)            %6.4f   (Z = %5.3f)\n", P, Z)
  my_sprintf("-------------------------------------------------\n")
  results <- ML_estimates_and_CIs_stratified_2x2(n, "linear", alpha)$statistics
  my_sprintf("Interval method     estimate         %i%% CI\n", 100 * (1 - alpha))
  my_sprintf("-------------------------------------------------\n")
  my_sprintf("Wald (MH)           %7.4f    %7.4f to %7.4f\n", deltahat_MH, L_MH, U_MH)
  my_sprintf("Wald (IV)           %7.4f    %7.4f to %7.4f\n", deltahat_IV, L_IV, U_IV)
  my_sprintf("Maximum likelihood  %7.4f    %7.4f to %7.4f\n", results$betahat, results$betahatCI[1], results$betahatCI[2])
  my_sprintf("-------------------------------------------------\n")

  my_sprintf("\nTests and CIs for a common ratio of probabilities\n")
  my_sprintf("=================================================\n")
  results <- Pearson_LR_test_common_effect_stratified_2x2(n, "log")$statistics
  my_sprintf("Test                 P-value  (test statistic)\n")
  my_sprintf("-------------------------------------------------\n")
  my_sprintf("Likelihood ratio     %6.4f   (T = %5.3f, df = %i)\n", results$P_LR, results$T_LR, results$df_LR)
  my_sprintf("Pearson chi-squared  %6.4f   (T = %5.3f, df = %i)\n", results$P_Pearson, results$T_Pearson, results$df_Pearson)
  tmp <- Wald_test_and_CI_common_ratio_stratified_2x2(n, "MH", alpha, FALSE)
  P <- tmp[[1]]
  Z <- tmp[[2]]
  L_MH <- tmp[[3]]
  U_MH <- tmp[[4]]
  deltahat_MH <- tmp[[5]]
  my_sprintf("Wald (MH)            %6.4f   (Z = %5.3f)\n", P, Z)
  tmp <- Wald_test_and_CI_common_ratio_stratified_2x2(n, "IV", alpha, FALSE)
  P <- tmp[[1]]
  Z <- tmp[[2]]
  L_IV <- tmp[[3]]
  U_IV <- tmp[[4]]
  deltahat_IV <- tmp[[5]]
  my_sprintf("Wald (IV)            %6.4f   (Z = %5.3f)\n", P, Z)
  my_sprintf("-------------------------------------------------\n")
  results <- ML_estimates_and_CIs_stratified_2x2(n, "log", alpha)$statistics
  my_sprintf("Interval method     estimate         %i%% CI\n", 100 * (1 - alpha))
  my_sprintf("-------------------------------------------------\n")
  my_sprintf("Wald (MH)           %7.4f    %7.4f to %7.4f\n", deltahat_MH, L_MH, U_MH)
  my_sprintf("Wald (IV)           %7.4f    %7.4f to %7.4f\n", deltahat_IV, L_IV, U_IV)
  my_sprintf("Maximum likelihood  %7.4f    %7.4f to %7.4f\n", exp(results$betahat), exp(results$betahatCI[1]), exp(results$betahatCI[2]))
  my_sprintf("-------------------------------------------------\n")

  my_sprintf("\nTests and CIs for a common odds ratio\n")
  my_sprintf("=====================================\n")
  results <- Pearson_LR_test_common_effect_stratified_2x2(n, "logit")$statistics
  my_sprintf("Test                     P-value  (test statistic)\n")
  my_sprintf("-----------------------------------------------------\n")
  my_sprintf("Likelihood ratio         %6.4f   (T = %5.3f, df = %i)\n", results$P_LR, results$T_LR, results$df_LR)
  my_sprintf("Pearson chi-squared      %6.4f   (T = %5.3f, df = %i)\n", results$P_Pearson, results$T_Pearson, results$df_Pearson)
  tmp <- CochranMantelHaenszel_test_stratified_2x2(n)
  P <- tmp[[1]]
  T0 <- tmp[[3]]
  df <- tmp[[2]]
  my_sprintf("Cochran-Mantel-Haenszel  %6.4f   (T = %5.3f, df = %i)\n", P, T0, df)
  tmp <- RBG_test_and_CI_stratified_2x2(n, alpha)$statistics
  P <- tmp[[1]]
  Z <- tmp[[2]]
  L_RBG <- tmp[[3]]
  U_RBG <- tmp[[4]]
  phihat_RBG <- tmp[[5]]
  my_sprintf("RBG                      %6.4f   (Z = %5.3f)\n", P, Z)
  tmp <- Woolf_test_and_CI_stratified_2x2(n, alpha, FALSE)
  P <- tmp[[1]]
  Z <- tmp[[2]]
  L_Woolf <- tmp[[3]]
  U_Woolf <- tmp[[4]]
  phihat_Woolf <- tmp[[5]]
  my_sprintf("Woolf                    %6.4f   (Z = %5.3f)\n", P, Z)
  my_sprintf("-----------------------------------------------------\n")
  results <- ML_estimates_and_CIs_stratified_2x2(n, "logit", alpha)$statistics
  my_sprintf("Interval method     estimate         %i%% CI\n", 100 * (1 - alpha))
  my_sprintf("-------------------------------------------------\n")
  my_sprintf("RBG (MH)            %7.4f    %7.4f to %7.4f\n", phihat_RBG, L_RBG, U_RBG)
  my_sprintf("Woolf (IV)          %7.4f    %7.4f to %7.4f\n", phihat_Woolf, L_Woolf, U_Woolf)
  my_sprintf("Maximum likelihood  %7.4f    %7.4f to %7.4f\n", exp(results$betahat), exp(results$betahatCI[1]), exp(results$betahatCI[1]))
  my_sprintf("-------------------------------------------------\n")
}
